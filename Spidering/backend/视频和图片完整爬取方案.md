# 视频和图片完整爬取方案分析

## 问题描述

在 `weibo.cn` 网页端，对于既有视频又有图片的微博，只会在内容处提供一个跳转到 `weibo.com` 的链接，无法直接获取完整的图片和视频信息。

## 参考代码分析（weibo.py）

### 1. 核心方法：`get_long_weibo(id)`

**位置**: `weibo.py` 第 572-587 行

**实现逻辑**:

```python
def get_long_weibo(self, id):
    """获取长微博"""
    url = "https://m.weibo.cn/detail/%s" % id
    html = self.session.get(url, headers=self.headers, verify=False).text
    # 从HTML中提取JSON数据
    html = html[html.find('"status":') :]
    html = html[: html.rfind('"call"')]
    html = html[: html.rfind(",")]
    html = "{" + html + "}"
    js = json.loads(html, strict=False)
    weibo_info = js.get("status")
    if weibo_info:
        weibo = self.parse_weibo(weibo_info)
        return weibo
```

**关键点**:

- 访问 `https://m.weibo.cn/detail/{id}` 页面
- 从 HTML 中提取包含 `"status":` 的 JSON 数据
- 解析 JSON 获取完整的微博信息

### 2. 图片提取：`get_pics(weibo_info)`

**位置**: `weibo.py` 第 589-597 行

```python
def get_pics(self, weibo_info):
    """获取微博原始图片url"""
    if weibo_info.get("pics"):
        pic_info = weibo_info["pics"]
        pic_list = [pic["large"]["url"] for pic in pic_info]
        pics = ",".join(pic_list)
    else:
        pics = ""
    return pics
```

**数据结构**:

- `weibo_info["pics"]` 是一个列表
- 每个元素有 `large.url` 字段（大图 URL）

### 3. 视频提取：`get_video_url(weibo_info)`

**位置**: `weibo.py` 第 604-618 行

```python
def get_video_url(self, weibo_info):
    """获取微博普通视频URL"""
    video_url = ""
    if weibo_info.get("page_info"):
        if weibo_info["page_info"].get("type") == "video":
            media_info = weibo_info["page_info"].get("urls") or weibo_info["page_info"].get("media_info")
            if media_info:
                video_url = (media_info.get("mp4_720p_mp4") or
                            media_info.get("mp4_hd_url") or
                            media_info.get("hevc_mp4_hd") or
                            media_info.get("mp4_sd_url") or
                            media_info.get("mp4_ld_mp4") or
                            media_info.get("stream_url_hd") or
                            media_info.get("stream_url"))
    return video_url
```

**数据结构**:

- `weibo_info["page_info"]["type"] == "video"` 表示是视频
- `media_info` 包含多个清晰度的视频 URL
- 优先级：720p > HD > SD > LD > stream

### 4. Live Photo 提取：`get_live_photo_url(weibo_info)`

**位置**: `weibo.py` 第 600-603 行

```python
def get_live_photo_url(self, weibo_info):
    """获取Live Photo视频URL"""
    live_photo_list = weibo_info.get("live_photo", [])
    return ";".join(live_photo_list) if live_photo_list else ""
```

## 实现方案

### 方案 1：检测并补充获取（推荐）

**步骤**:

1. 在 `get_weibo_content()` 中检测是否只获取到跳转链接
2. 如果检测到，访问 `m.weibo.cn/detail/{wid}` 获取完整信息
3. 从 JSON 中提取图片和视频 URL
4. 合并到现有数据中

**优点**:

- 保持现有逻辑不变
- 只在需要时补充获取
- 兼容性好

### 方案 2：直接使用 m.weibo.cn API

**步骤**:

1. 直接访问 `m.weibo.cn/detail/{wid}` 获取完整信息
2. 作为主要数据源，weibo.cn 作为备用

**优点**:

- 数据更完整
- 一次获取所有信息

**缺点**:

- 需要修改现有逻辑
- 可能影响其他功能

## 推荐实现（方案 1）

### 检测条件

在 `weibo.cn` 页面中，如果检测到以下情况，说明需要补充获取：

1. 内容中包含 "查看图片" 或 "查看视频" 的跳转链接
2. 图片数量为 0 但内容中有图片相关文本
3. 视频数量为 0 但内容中有视频相关文本

### 实现代码框架

```python
def _get_weibo_from_mobile(self, weibo_id):
    """
    从 m.weibo.cn 获取完整微博信息（包括图片和视频）

    Args:
        weibo_id: 微博ID（可以是mid或数字id）

    Returns:
        dict: 包含完整图片和视频信息的字典，如果失败返回None
    """
    url = f"https://m.weibo.cn/detail/{weibo_id}"
    try:
        response = self.session.get(url, headers=self.headers, verify=False, timeout=10)
        if response.status_code != 200:
            return None

        html = response.text
        # 查找JSON数据
        status_start = html.find('"status":')
        if status_start == -1:
            return None

        html = html[status_start:]
        # 查找结束位置
        call_end = html.rfind('"call"')
        if call_end == -1:
            return None

        html = html[:call_end]
        html = html[:html.rfind(",")]
        html = "{" + html + "}"

        js = json.loads(html, strict=False)
        weibo_info = js.get("status")

        if not weibo_info:
            return None

        # 提取图片
        images = []
        if weibo_info.get("pics"):
            for pic in weibo_info["pics"]:
                if pic.get("large") and pic["large"].get("url"):
                    images.append(pic["large"]["url"])

        # 提取视频
        videos = []
        if weibo_info.get("page_info"):
            page_info = weibo_info["page_info"]
            if page_info.get("type") == "video":
                media_info = page_info.get("urls") or page_info.get("media_info")
                if media_info:
                    # 按优先级获取视频URL
                    video_url = (media_info.get("mp4_720p_mp4") or
                               media_info.get("mp4_hd_url") or
                               media_info.get("hevc_mp4_hd") or
                               media_info.get("mp4_sd_url") or
                               media_info.get("mp4_ld_mp4") or
                               media_info.get("stream_url_hd") or
                               media_info.get("stream_url"))
                    if video_url:
                        videos.append(video_url)

        # 提取Live Photo
        live_photos = []
        if weibo_info.get("live_photo"):
            live_photos = weibo_info["live_photo"]

        return {
            'images': images,
            'videos': videos,
            'live_photos': live_photos
        }
    except Exception as e:
        print(f'从 m.weibo.cn 获取信息失败: {e}')
        return None
```

## 可行性评估

### ✅ 可行性：高

**理由**:

1. `weibo.py` 中已有成功实现
2. `m.weibo.cn` API 相对稳定
3. 数据结构清晰，易于解析
4. 可以与现有代码无缝集成

### ⚠️ 注意事项

1. **ID 格式**: `m.weibo.cn/detail/{id}` 可以使用 mid（如 `QbelLys5Z`）或数字 id
2. **Cookie 要求**: 需要有效的 Cookie 才能访问
3. **HTML 结构变化**: 如果微博更新 HTML 结构，JSON 提取逻辑可能需要调整
4. **错误处理**: 需要完善的异常处理，避免影响主流程

## 实施建议

1. **第一步**: 实现 `_get_weibo_from_mobile()` 方法
2. **第二步**: 在 `get_weibo_content()` 中检测是否需要补充获取
3. **第三步**: 合并数据，确保不覆盖已有数据
4. **第四步**: 测试各种情况（纯图片、纯视频、图片+视频、无媒体）

## 检测逻辑

```python
# 检测是否需要从 m.weibo.cn 补充获取
need_supplement = False

# 情况1：内容中有跳转链接但图片/视频为空
if (len(images) == 0 and len(videos) == 0 and
    ('查看图片' in content or '查看视频' in content or
     'm.weibo.cn' in content or 'weibo.com' in content)):
    need_supplement = True

# 情况2：检测到视频链接但视频URL为空
if video_links and len(videos) == 0:
    need_supplement = True

if need_supplement:
    print('  检测到需要补充获取完整媒体信息...')
    mobile_data = self._get_weibo_from_mobile(weibo_id)
    if mobile_data:
        # 合并图片（去重）
        for img in mobile_data.get('images', []):
            if img not in images:
                images.append(img)

        # 合并视频（去重）
        for vid in mobile_data.get('videos', []):
            if vid not in videos:
                videos.append(vid)

        print(f'  补充获取: {len(mobile_data.get("images", []))} 张图片, {len(mobile_data.get("videos", []))} 个视频')
```
